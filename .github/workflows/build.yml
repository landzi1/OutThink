name: Build BookSummarizer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            TARGET: linux
            OUT_FILE_PATTERN: "BookSummarizer*.AppImage" # Szukamy AppImage
          - os: windows-latest
            TARGET: windows
            OUT_FILE_PATTERN: "dist/BookSummarizer.exe"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # KROK: PokaÅ¼ pliki (Debug)
      - name: ðŸ” List files
        run: |
          python -c "import os; print('FILES:', os.listdir('.'))"

      # Instalacja zaleÅ¼noÅ›ci systemowych (Linux)
      - name: Install System Deps (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk tcl-dev tk-dev fuse libfuse2

      - name: Install Python Deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 1. BUDOWANIE BINARKI (WINDOWS)
      - name: Build EXE (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          pyinstaller --noconfirm --onefile --windowed --name "BookSummarizer" --add-data "logo.jpg;." --hidden-import=PIL --hidden-import=customtkinter --hidden-import=gtts --hidden-import=langdetect booksummarizer.py

      # 2. BUDOWANIE BINARKI (LINUX) - Etap 1
      - name: Build Binary (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          pyinstaller --noconfirm --onefile --windowed --name "BookSummarizer" --add-data "logo.jpg:." --hidden-import=PIL --hidden-import=customtkinter --hidden-import=gtts --hidden-import=langdetect booksummarizer.py

      # 3. TWORZENIE APPIMAGE (LINUX) - Etap 2 (Wrapper)
      - name: Create AppImage (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # A. Przygotuj strukturÄ™ folderÃ³w AppDir
          mkdir -p AppDir/usr/bin

          # B. Skopiuj naszÄ… aplikacjÄ™ jako 'AppRun' (to plik startowy)
          cp dist/BookSummarizer AppDir/AppRun
          chmod +x AppDir/AppRun

          # C. Konwertuj logo.jpg na logo.png (AppImage woli PNG)
          python -c "from PIL import Image; Image.open('logo.jpg').save('AppDir/logo.png')"

          # D. StwÃ³rz plik .desktop (WizytÃ³wka aplikacji)
          cat > AppDir/booksummarizer.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=BookSummarizer
          Exec=AppRun
          Icon=logo
          Categories=Utility;Education;
          EOF

          # E. Pobierz narzÄ™dzie appimagetool
          wget -q https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # F. Zbuduj finalny plik .AppImage
          # UÅ¼ywamy --appimage-extract-and-run bo GitHub Actions nie ma FUSE
          ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir

      # PRZESYÅANIE GOTOWYCH PLIKÃ“W
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: BookSummarizer-${{ matrix.TARGET }}
          path: ${{ matrix.OUT_FILE_PATTERN }}
